---
title: "CPC Merged Analysis of Precipitation (CMAP)"
output: html_document
date: '2022-05-30'
---

```{r}
library(ncdf4)

# set path and filename
ncpath <- "/Users/hwingren/Downloads/Blackwell/"
ncname <- "precip.mon.mean.nc"  
ncfname <- paste(ncpath, ncname, sep="")
dname <- "precip"
```


# open a netCDF file
```{r}
ncin <- nc_open(ncfname)
print(ncin)
```

# get longitude and latitude
```{r}
lon <- ncvar_get(ncin,"lon")
nlon <- dim(lon)
head(lon)

lat <- ncvar_get(ncin,"lat")
nlat <- dim(lat)
head(lat)

print(c(nlon,nlat))
```

# get time
```{r}
time <- ncvar_get(ncin,"time")
time

tunits <- ncatt_get(ncin,"time","units")
nt <- dim(time)
nt

tunits
```

# get precipitation
```{r}
precip_array <- ncvar_get(ncin,dname)
dlname <- ncatt_get(ncin,dname,"long_name")
dunits <- ncatt_get(ncin,dname,"units")
fillvalue <- ncatt_get(ncin,dname,"_FillValue")
dim(precip_array)
```

# get global attributes
```{r}
title <- ncatt_get(ncin,0,"title")
institution <- ncatt_get(ncin,0,"institution")
datasource <- ncatt_get(ncin,0,"source")
references <- ncatt_get(ncin,0,"references")
history <- ncatt_get(ncin,0,"history")
Conventions <- ncatt_get(ncin,0,"Conventions")

nc_close(ncin)
```

# load some packages
```{r}
library(chron)
library(lattice)
library(RColorBrewer)
```

# convert time -- split the time units string into fields
```{r}
tustr <- strsplit(tunits$value, " ")
tdstr <- strsplit(unlist(tustr)[3], "-")
tmonth <- as.integer(unlist(tdstr)[2])
tday <- as.integer(unlist(tdstr)[3])
tyear <- as.integer(unlist(tdstr)[1])
chron(time,origin=c(tmonth, tday, tyear))
```

# replace netCDF fill values with NA's
```{r}
precip_array[precip_array==fillvalue$value] <- NA

length(na.omit(as.vector(precip_array[,,1])))
```

# get a single slice or layer (January)
```{r}
m <- 1
precip_slice <- precip_array[,,m]
dim(precip_slice)
```

# quick map
```{r}
image(lon,rev(lat),precip_slice[, ncol(precip_slice):1], col=rev(brewer.pal(10,"RdBu")))
```

# levelplot of the slice
```{r}
grid <- expand.grid(lon=lon, lat=lat)
cutpts <- seq(0, 45, length.out=11)
levelplot(precip_slice ~ lon * lat, data=grid, at=cutpts, cuts=11, pretty=T, 
  col.regions=(rev(brewer.pal(10,"RdBu"))))
```
            
# create new lon and lat vectors
```{r}
lon_new <- c(lon[73:144]-360, lon[1:72])
lat_new <- rev(lat)
```

# create new precipitation matrix
```{r}
precip_slice_new <- precip_slice[c(73:144, 1:72), ncol(precip_slice):1]
```

# plot whole globe
```{r}
image(lon_new, lat_new, precip_slice_new, col=rev(brewer.pal(10,"RdBu")))
```

# create boolean masks corresponding to region of interest
```{r}
lon_mask <- -75<=lon_new & lon_new <=(-60) # need parentheses here because <- is the assignment operator
lat_mask <- 0<=lat_new & lat_new<=10
```

# plot region of interest
```{r}
image(lon_new[lon_mask], lat_new[lat_mask], precip_slice_new[lon_mask, lat_mask], col=rev(brewer.pal(10,"RdBu")))
```